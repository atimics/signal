# Sprint 4.2: Rendering Code Refactor

**Duration**: 3 Days
**Priority**: High
**Dependencies**: Sprint 4.1 (Visual Output Restored)

## Sprint Goal
Refactor the rendering code to establish a clean, maintainable, and extensible foundation for future rendering features. This sprint addresses the technical debt incurred during the rapid implementation of Sprint 4.1.

## Current State
- ‚úÖ Meshes are rendering on screen.
- üü° Rendering logic is currently in `main.c` or `render_3d.c`.
- üü° `render_mesh.c` is an unused placeholder file.
- ‚ùå Meshes do not respect their `Transform` components (position, rotation, scale).
- ‚ùå The `Material` component is not yet used for rendering.

## Target State
- ‚úÖ All mesh rendering logic is encapsulated within `render_mesh.c`.
- ‚úÖ The main render loop in `main.c` is clean and only calls high-level system functions.
- ‚úÖ Each rendered entity correctly uses its `Transform` component to position, rotate, and scale itself in the world.
- ‚úÖ The rendering pipeline uses the `Material` component to apply the correct base color to each mesh.
- ‚úÖ The codebase is prepared for the implementation of the 3D camera system in Sprint 07.

---

## Tasks

### Task 4.2.1: Refactor Mesh Rendering Logic
**Estimated**: 1 day
**Files**: `src/main.c`, `src/render_3d.c`, `src/render_mesh.c`, `src/render_mesh.h`

#### Acceptance Criteria
- [ ] Create a `render_mesh_system_update()` function in `render_mesh.c`.
- [ ] Move the entity iteration and `sg_draw` logic from `main.c` / `render_3d.c` into this new function.
- [ ] The main `frame()` callback should now simply call `render_mesh_system_update()`.
- [ ] The `render_mesh.h` header should be updated to declare the new system function.

### Task 4.2.2: Implement Transform Matrices
**Estimated**: 1 day
**Files**: `src/render_mesh.c`, `src/core.c` (for matrix math)

#### Acceptance Criteria
- [ ] Implement matrix creation functions for translation, rotation (from quaternion), and scale.
- [ ] Create a function `mat4_compose_transform(transform)` that generates a model matrix from a `Transform` component.
- [ ] In `render_mesh_system_update`, calculate the model matrix for each entity.
- [ ] Calculate the final MVP (Model-View-Projection) matrix by multiplying `camera_vp * model_matrix`.
- [ ] Pass the final MVP matrix to the vertex shader.

### Task 4.2.3: Integrate Material Colors
**Estimated**: 1 day
**Files**: `src/render_mesh.c`, `assets/shaders/`

#### Acceptance Criteria
- [ ] The `render_mesh_system_update` function should get the `Material` component for each entity.
- [ ] The fragment shader should be updated to accept a `vec4` uniform for diffuse color.
- [ ] The `render_mesh_system_update` function should pass the `diffuse_color` from the entity's `Material` component to the fragment shader.
- [ ] Each of the four initial entities should render with its correct, distinct color as defined in the asset files.

---

## Definition of Done
- [ ] The `render_mesh.c` file contains all logic for drawing meshes.
- [ ] The four initial entities (Control Tower, Sun, Wedge Ships) are all visible and rendered at their correct, distinct positions and scales.
- [ ] Each entity is rendered with its correct material color.
- [ ] The code is clean, organized, and ready for the next sprint.
