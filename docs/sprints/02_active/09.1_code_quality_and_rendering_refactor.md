
# Sprint 9.1: Code Quality and Rendering Refactor

**Duration**: 3 Days
**Priority**: High
**Dependencies**: Sprint 09 (Texture System)

## Sprint Goal
Improve the quality, maintainability, and modularity of the core C codebase, with a special focus on refactoring the rendering system. This sprint will address the technical debt identified in `src/render_3d.c` and establish a cleaner, more robust foundation for future rendering features.

## Analysis of Current Code Quality
- **Monolithic `render_3d.c`**: This file currently handles Sokol initialization, global state management, the main render loop, and fallback test geometry, violating the single-responsibility principle.
- **Redundant Camera Logic**: The `render_frame` function contains a fallback path to create a hardcoded camera, which is redundant as the ECS `Camera` system should be the single source of truth.
- **Inactive `render_mesh.c` Module**: The `render_mesh.c` file, intended to handle the drawing of individual meshes, is currently disabled. Its logic is instead embedded within the main render loop, reducing modularity.
- **Debug Clutter**: The rendering code is cluttered with `printf` statements and a fallback test triangle, which makes the primary rendering path difficult to follow.

## Technical Debt and Refactoring Tasks

### Task 9.1.1: Activate and Implement `render_mesh.c`
**Estimated**: 1 day
**Files**: `src/render_3d.c`, `src/render_mesh.c`, `src/render_mesh.h`

#### Acceptance Criteria
- [ ] Re-enable the `render_mesh.c` and `render_mesh.h` files.
- [ ] Create a new function: `void render_mesh_from_entity(const struct Entity* entity, const float* view_projection_matrix)`.
- [ ] Move all logic for drawing a single entity (component fetching, matrix composition, `sg_apply_bindings`, `sg_apply_uniforms`, `sg_draw`) from the main loop in `render_3d.c` into this new function.
- [ ] The `render_mesh_from_entity` function must be self-contained and only operate on the data passed to it.

### Task 9.1.2: Refactor the Main Render Loop
**Estimated**: 1 day
**Files**: `src/render_3d.c`, `src/systems.c`

#### Acceptance Criteria
- [ ] The `render_frame` function in `src/render_3d.c` must be refactored to be a clean, high-level loop.
- [ ] It must get the active camera from the `World` **once** at the beginning of the frame.
- [ ] **The fallback camera logic must be removed.** If no active camera is found, the function must return immediately without rendering anything.
- [ ] The loop will iterate through all entities and call the new `render_mesh_from_entity` function for each renderable entity.
- [ ] The fallback test triangle rendering must be removed.

### Task 9.1.3: Consolidate Global Render State
**Estimated**: 0.5 days
**Files**: `src/render_3d.c`, `src/render.h`

#### Acceptance Criteria
- [ ] The global `render_state` struct (containing the pipeline, shader, etc.) should be clearly defined and its scope limited as much as possible.
- [ ] The `RenderConfig` struct should be reviewed and simplified, removing any fields that are now managed by the ECS (e.g., the legacy camera).

### Task 9.1.4: Improve Code Clarity and Remove Clutter
**Estimated**: 0.5 days
**Files**: `src/render_3d.c`, `src/systems.c`

#### Acceptance Criteria
- [ ] Remove all temporary `printf` debugging statements from the rendering pipeline.
- [ ] Add comments to clarify complex sections of the code, such as the matrix calculations and the Sokol pipeline setup.
- [ ] Ensure consistent code formatting and style throughout the rendering files.

## Definition of Done
- [ ] The `render_mesh.c` file is active and contains all logic for drawing a single mesh.
- [ ] The `render_3d.c` file is a clean, high-level render loop that delegates all drawing to `render_mesh.c`.
- [ ] The renderer is strictly driven by the ECS, with no fallback camera or test triangle logic.
- [ ] The codebase is more modular, easier to understand, and has less duplication.
- [ ] The application compiles and runs without any visual or functional regressions.
