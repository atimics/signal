# Sprint 11.6: Code Consolidation & Refactoring

**ID**: `sprint_11.6`
**Status**: **BACKLOG**
**Lead**: Gemini (Lead Scientist and Researcher)
**Related Research**: N/A (Codebase analysis)

## 1. Sprint Goal

To improve the overall health, maintainability, and readability of the CGame codebase by refactoring large, monolithic files, removing legacy code, and enforcing a consistent coding style. This sprint will pay down technical debt accumulated during the rapid prototyping and stabilization phases, resulting in a cleaner and more professional foundation.

## 2. Key Refactoring Tasks

This sprint is focused on targeted refactoring and cleanup, not new features.

### **Task 1: Refactor `assets.c` into Multiple Modules**

*   **Objective**: To break down the monolithic `assets.c` file into smaller, single-responsibility modules.
*   **Plan**:
    1.  Create a new `src/asset_loader/` directory.
    2.  Create `asset_loader_index.c/h` for functions related to parsing `index.json`.
    3.  Create `asset_loader_mesh.c/h` for functions related to parsing `.cobj` files (`parse_obj_file`).
    4.  Create `asset_loader_material.c/h` for functions related to parsing `.mtl` files.
    5.  The main `assets.c/h` will become a simpler interface that orchestrates these new, smaller modules.

### **Task 2: Remove Legacy Code**

*   **Objective**: To eliminate redundant and unused code from the project.
*   **Plan**:
    1.  **Remove `load_legacy_metadata`**: Delete the function from `assets.c` and any calls to it. The `index.json` system is now the single source of truth.
    2.  **Consolidate Mesh Loading**: Remove the `load_compiled_mesh` function and refactor `load_compiled_mesh_absolute` to be the single, canonical mesh loading function.
    3.  **Remove Test Triangle**: Delete the fallback rendering code for the test triangle from `render_3d.c`. The engine should now be robust enough to render real meshes or fail gracefully.

### **Task 3: Decouple Scene Logic from `main.c`**

*   **Objective**: To move hardcoded scene setup and entity creation logic out of `main.c` and into our data-driven systems.
*   **Plan**:
    1.  Remove the `create_player` and `simulate_player_input` functions from `main.c`.
    2.  Update the scene files in `/data/scenes/` to define the player entity and its initial state.
    3.  The `load_scene_by_name` function in `data.c` should become the sole authority for populating the world.

### **Task 4: Code Style and Documentation Pass**

*   **Objective**: To enforce a consistent coding style and ensure all public functions are clearly documented.
*   **Plan**:
    1.  Run a code formatter (like `clang-format`) across the entire `src/` directory to standardize indentation, spacing, and brace style.
    2.  Review all `.h` files and add clear, Doxygen-style comments for all public functions, explaining their purpose, parameters, and return values.

## 3. Definition of Done

This sprint is **DONE** when:
1.  The `assets.c` file has been successfully refactored into smaller modules.
2.  All identified legacy code has been removed.
3.  `main.c` is free of hardcoded scene logic.
4.  The codebase has a consistent, auto-formatted style.
5.  Crucially, `make test-full` and `make run` both execute successfully, proving that the refactoring has not introduced any regressions.
