# Sprint 11.6: Code Consolidation - Implementation Guide

**ID**: `sprint_11.6`
**Status**: **ACTIVE & CRITICAL**
**Author**: Gemini (Lead Scientist and Researcher)

## 1. Sprint Goal

To improve the overall health, maintainability, and readability of the CGame codebase by refactoring large, monolithic files, removing legacy code, and enforcing a consistent coding style. This sprint will pay down technical debt accumulated during the rapid prototyping and stabilization phases, resulting in a cleaner and more professional foundation.

## 2. Definition of Done

This sprint is **DONE** when:
1.  The `assets.c` file has been successfully refactored into smaller modules.
2.  All identified legacy code has been removed.
3.  `main.c` is free of hardcoded scene logic.
4.  The codebase has a consistent, auto-formatted style.
5.  Crucially, `make test-full` and `make run` both execute successfully, proving that the refactoring has not introduced any regressions.

---

## 3. Refactoring Tasks & Guidance

### **Task 1: Refactor `assets.c` into Multiple Modules**

*   **Problem**: `assets.c` is over 650 lines and handles too many distinct responsibilities (pathing, parsing, GPU upload, metadata).
*   **Guidance**:
    1.  Create a new directory: `src/asset_loader/`.
    2.  Create `src/asset_loader/loader_index.c` and move the `assets_get_mesh_path_from_index` function into it.
    3.  Create `src/asset_loader/loader_mesh.c` and move `parse_obj_file` into it.
    4.  Create `src/asset_loader/loader_material.c` and move `parse_mtl_file` into it.
    5.  The main `assets.c` should be significantly smaller, acting as a high-level interface that calls these new modules. Update the `Makefile` to include the new source files in the build.

### **Task 2: Remove Legacy Code**

*   **Problem**: The codebase contains redundant functions and outdated logic.
*   **Guidance**:
    1.  **In `assets.c`**:
        *   Delete the `load_legacy_metadata` function. The `index.json` format is now the only supported method.
        *   Delete the `load_compiled_mesh` function. The `load_compiled_mesh_absolute` function should be renamed to `load_mesh_from_file` and become the single function for this purpose.
    2.  **In `render_3d.c`**:
        *   Delete the static `test_vertices` and `test_indices` arrays.
        *   Delete the fallback logic in `render_frame` that draws the test triangle (`if (rendered_count == 0) { ... }`). The engine should now be robust enough to render nothing if no valid entities are present.

### **Task 3: Decouple Scene Logic from `main.c`**

*   **Problem**: `main.c` contains hardcoded logic for creating the player and simulating input, which should be data-driven.
*   **Guidance**:
    1.  Delete the `create_player` and `simulate_player_input` static functions from `main.c`.
    2.  Modify the scene files (e.g., `data/scenes/spaceport.txt`) to include the player entity via the template system. A `player_start` entity template might be required.
    3.  The `load_scene` function in `data.c` should be the single point of entry for populating the world based on the data files.

### **Task 4: Code Style and Documentation Pass**

*   **Problem**: Minor inconsistencies in style and a lack of function-level documentation.
*   **Guidance**:
    1.  **Formatting**: Agree on a `clang-format` style and apply it to all files in `src/`. This is a one-time action that ensures consistency forever.
    2.  **Documentation**: Go through every public function in every `.h` file in `src/` and add a Doxygen-style comment block explaining its purpose, parameters, and return value. This is critical for long-term maintainability.
        *   **Example**:
            ```c
            /**
             * @brief Initializes the asset registry and sets the root asset path.
             * @param registry Pointer to the AssetRegistry to initialize.
             * @param asset_root The absolute path to the root assets directory.
             * @return True on success, false on failure.
             */
            bool assets_init(AssetRegistry* registry, const char* asset_root);
            ```

This sprint, while not adding new features, is one of the most important we will undertake. A clean, well-documented, and maintainable codebase is the foundation upon which all future success is built.
