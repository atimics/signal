# Sprint 11.7: Shader Unification and Rendering Fix

**Document Owner**: Gemini (Lead Scientist and Researcher)
**Status**: Proposed
**Sprint Type**: Bug Fix & Refactor
**Related Sprints**: 10.5 (Mesh System Repair), 11.5 (Graphics API Refactor)

## 1. Sprint Goal

To resolve the visual rendering artifacts (distorted, uncolored meshes) by unifying the shader source code and ensuring a single, consistent rendering pipeline is used for all 3D mesh rendering.

## 2. Problem Statement

Investigation has revealed a critical architectural conflict causing the rendering issues.

*   `render_3d.c` correctly loads and compiles shaders from the `assets/shaders/` directory.
*   `render_mesh.c`, however, contains its own hardcoded, outdated shader source code.
*   This results in two different shader programs and pipeline configurations attempting to render the same objects, leading to incorrect vertex attribute mapping and a failure to apply textures and lighting. The hardcoded shader is winning the battle, resulting in the gray, distorted output.

## 3. Test-Driven Development Plan

This plan will be executed by a human developer. The goal is to create a failing test that demonstrates the bug, implement the fix, and then confirm the test passes.

### Test Case: `test_textured_mesh_rendering()`

A new test will be created in `tests/test_rendering.c`.

1.  **Setup**:
    *   Initialize the rendering system.
    *   Load a simple mesh with a known texture (e.g., a cube with a colored texture).
    *   Place the mesh in front of a camera.
2.  **Execution**:
    *   Render a single frame.
    *   Capture the rendered frame buffer (or a specific pixel from it).
3.  **Assertion (Expected to Fail Initially)**:
    *   Assert that the color of a specific pixel from the center of the rendered mesh is the expected color from the texture, not gray.
    *   This test **must fail** before the code changes are made.

### Implementation Steps

1.  **Remove Hardcoded Shaders**: Delete the `vs_source` and `fs_source` character arrays from `mesh_renderer_init()` in `src/render_mesh.c`.
2.  **Remove Redundant Pipeline Creation**: The `sg_shader` and `sg_pipeline` creation logic within `mesh_renderer_init()` is redundant and conflicts with the primary pipeline in `render_3d.c`. This logic should be removed. The `mesh_renderer_init` function should likely be simplified to only initialize its own state, without creating GPU resources that are already managed by `render_3d.c`.
3.  **Consolidate Pipeline Usage**: Refactor `render_frame()` in `src/render_3d.c` to be the single source of truth for the 3D rendering pipeline. The existing logic in `render_frame` already iterates through entities and submits draw calls. The call to `mesh_renderer_render_entity` is part of an incomplete refactor and should be removed or integrated properly. For this sprint, we will assume `render_3d.c` handles all rendering.
4.  **Verify Vertex Attribute Layout**: Ensure the `sg_pipeline_desc` in `render_sokol_init()` within `src/render_3d.c` correctly maps the vertex attributes (`position`, `normal`, `texcoord`) to the locations expected by the shaders loaded from the filesystem. This appears to be correct already but should be double-checked.

### Validation

1.  **Run the Test**: Execute the new `test_textured_mesh_rendering()` test. It should now **pass**.
2.  **Run the Engine**: Compile and run the main application (`make run`). All meshes should now render with their correct textures and basic lighting.
3.  **Run Full Test Suite**: Run `make test` to ensure no regressions have been introduced.

## 4. Definition of Done

*   All hardcoded shader source code is removed from `src/render_mesh.c`.
*   The engine exclusively uses the shaders from the `/assets/shaders` directory for 3D mesh rendering.
*   The new `test_textured_mesh_rendering` test passes.
*   The main application renders textured and lit meshes correctly.
*   The `make` and `make test` commands complete successfully without errors or warnings.
