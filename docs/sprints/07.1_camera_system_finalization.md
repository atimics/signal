# Sprint 7.1: 3D Camera System Finalization

**Duration**: 1 week
**Priority**: High
**Dependencies**: Sprint 4.2 (Rendering Refactor)

## Sprint Goal
Complete the 3D camera system by implementing the necessary matrix mathematics, fully integrating the camera with the ECS and rendering pipeline, and enabling proper 3D perspective rendering of the scene. This sprint addresses the outstanding issues from the initial camera implementation.

## Current State
- ✅ `Camera` component exists in the ECS.
- ✅ Camera switching via keyboard input is functional.
- ❌ No view or projection matrix calculations are being performed.
- ❌ The `camera_system_update` is a stub and does not control the camera.
- ❌ The rendering pipeline does not use camera data, resulting in a flat, orthographic view.

## Target State
- ✅ A `matrix_math.h` library contains robust functions for `mat4_perspective` and `mat4_lookat`.
- ✅ The `Camera` component caches its `view_projection_matrix` and uses a `dirty` flag for efficient updates.
- ✅ The `camera_system_update` correctly updates the active camera's matrices when it moves.
- ✅ The `render_mesh` system uses the active camera's `view_projection_matrix` to calculate the final MVP matrix for each entity.
- ✅ The rendered scene clearly shows 3D perspective, with objects appearing smaller in the distance.

---

## Tasks

### Task 7.1.1: Implement Core Matrix Math
**Estimated**: 1 day
**Files**: `src/matrix_math.c`, `src/matrix_math.h` (new files)

#### Acceptance Criteria
- [ ] Create a new file for matrix operations to keep `core.c` clean.
- [ ] Implement a `mat4_perspective()` function.
- [ ] Implement a `mat4_lookat()` function.
- [ ] Ensure all necessary matrix and vector utility functions (`multiply`, `normalize`, etc.) are present and correct.

### Task 7.1.2: Enhance Camera Component
**Estimated**: 0.5 days
**Files**: `src/core.h`

#### Acceptance Criteria
- [ ] Add `view_matrix`, `projection_matrix`, and `view_projection_matrix` (all `float[16]`) to the `Camera` struct.
- [ ] Add a `bool matrices_dirty` flag to the `Camera` struct.

### Task 7.1.3: Implement Camera System Logic
**Estimated**: 1.5 days
**Files**: `src/systems.c`, `src/render_camera.c`

#### Acceptance Criteria
- [ ] The `camera_system_update` function in `systems.c` should be the single source of truth for updating the camera.
- [ ] It should get the active camera entity from the `World`.
- [ ] It should call control logic (like `camera_follow_entity` from `render_camera.c`) to update the camera's position and target.
- [ ] After moving, it must set the camera's `matrices_dirty` flag to `true`.
- [ ] If the `matrices_dirty` flag is true, it must call a new `camera_update_matrices` function.
- [ ] `camera_update_matrices` will use the new matrix math functions to calculate and cache the camera's matrices.

### Task 7.1.4: Integrate Camera into Render Pipeline
**Estimated**: 1 day
**Files**: `src/render_mesh.c`

#### Acceptance Criteria
- [ ] The `render_mesh_system_update` function must get the active camera from the `World`.
- [ ] It must use the camera's cached `view_projection_matrix` when calculating the final MVP matrix for each entity.
- [ ] If no camera is active, it should fall back to an identity matrix to prevent crashes.
- [ ] The rendered output should now correctly show 3D perspective.

---

## Definition of Done
- [ ] All matrix math functions are implemented and functional.
- [ ] The `camera_system_update` correctly manages the active camera's state and matrices.
- [ ] The rendering pipeline uses the camera matrices, resulting in a correct 3D perspective view.
- [ ] The application runs without errors or visual artifacts related to the camera.
