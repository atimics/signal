
# Sprint 9.2: Rendering Pipeline Correction and Hardening

**Duration**: 2 Days
**Priority**: High
**Dependencies**: Sprint 9.1

## Sprint Goal
Correct the core rendering pipeline to ensure reliable and efficient mesh rendering. This sprint will fix the underlying cause of the "invisible mesh" problem by properly configuring the GPU state and adding validation and debugging features to prevent similar issues in the future.

## Analysis of Current Problems
- **Incorrect Face Winding**: The pipeline is configured for Counter-Clockwise (CCW) winding, but the source meshes likely use Clockwise (CW) winding, causing them to be culled incorrectly when back-face culling is enabled.
- **Culling Disabled**: Back-face culling is currently disabled (`SG_CULLMODE_NONE`) as a workaround. This hurts performance as it forces the GPU to render twice as many triangles as necessary.
- **Lack of Debug Visualizations**: There are no tools to visually debug rendering issues like incorrect normals, winding order, or culling.

## Technical Tasks

### Task 9.2.1: Correct Face Winding and Re-enable Culling
**Estimated**: 0.5 days
**Files**: `src/render_3d.c`

#### Acceptance Criteria
- [ ] Change the `face_winding` property in the `sg_pipeline_desc` to `SG_FACEWINDING_CW` to match the expected winding order of the source assets.
- [ ] Re-enable back-face culling by setting `cull_mode` to `SG_CULLMODE_BACK`.
- [ ] All meshes must now render correctly with back-face culling enabled.

### Task 9.2.2: Implement a Wireframe Debug Mode
**Estimated**: 1 day
**Files**: `src/render_3d.c`, `src/ui.c`

#### Acceptance Criteria
- [ ] Create a second, separate Sokol pipeline (`render_state.wireframe_pipeline`) that is identical to the main pipeline but uses `SG_RASTERIZER_LINE_STRIP_ADJ` or a similar wireframe-compatible rasterizer state.
- [ ] Add a new boolean flag, `render_config.wireframe_mode`, to the global render configuration.
- [ ] In the main render loop, if `wireframe_mode` is true, apply the wireframe pipeline instead of the solid-fill pipeline.
- [ ] Add a checkbox to the Nuklear debug UI to toggle wireframe mode in real-time. This will allow developers to instantly see the underlying geometry of the scene.

### Task 9.2.3: Add Normal Vector Visualization
**Estimated**: 1 day
**Files**: `assets/shaders/`, `src/render_3d.c`

#### Acceptance Criteria
- [ ] Create a new, simple shader (`debug_normals.glsl`/`.metal`) that visualizes vertex normals as colors. The vertex shader will pass the normal vector to the fragment shader, which will map the X, Y, and Z components of the normal to the R, G, and B color channels.
- [ ] Create a third Sokol pipeline (`render_state.normal_debug_pipeline`) that uses this new shader.
- [ ] Add a `render_config.normal_debug_mode` flag and a corresponding checkbox in the UI to toggle this visualization.
- [ ] This will make it easy to verify that normals are correct and pointing in the right direction.

## Definition of Done
- [ ] The face winding issue is corrected, and back-face culling is enabled and working as expected.
- [ ] Developers can toggle a wireframe view of the scene in real-time via the debug UI.
- [ ] Developers can toggle a normal vector visualization in real-time via the debug UI.
- [ ] The rendering pipeline is more robust and easier to debug.
- [ ] The application compiles and runs without any visual or functional regressions.
