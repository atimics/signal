# Mesh Asset Format and Schema

This document outlines the structure, format, and standards for mesh assets used in the SIGNAL engine, as well as the pipeline for generating and managing them.

## Asset Pipeline Overview

The engine uses a **compiled asset system** where source meshes (`.obj` or `.mesh` files) are processed by the asset compiler into optimized `.cobj` (compiled OBJ) files along with associated metadata. This compilation step:

- Converts source mesh formats to a standardized `.cobj` format
- Generates per-mesh metadata in JSON format  
- Validates mesh integrity and repairs common issues
- Creates an asset index for efficient loading
- Produces ready-to-use textures and materials

## Directory Structure

### Source Assets (`assets/meshes/`)

Source assets are organized in categorized subdirectories with standardized filenames:

```
assets/meshes/
├── README.md               # This file
├── index.json             # Asset index
├── schema.json            # JSON schema for validation
├── props/                 # Category directory
│   ├── sun/               # Individual mesh directory
│   │   ├── geometry.mesh  # Source mesh file (standardized name)
│   │   ├── material.mtl   # Material definition (standardized name)
│   │   ├── texture.png    # Texture file (standardized name)
│   │   └── metadata.json  # Mesh metadata (standardized name)
│   ├── wedge_ship/        # Another mesh
│   │   ├── geometry.mesh
│   │   ├── material.mtl
│   │   ├── texture.png
│   │   └── metadata.json
│   └── control_tower/     # Yet another mesh
│       ├── geometry.mesh
│       ├── material.mtl
│       ├── texture.png
│       └── metadata.json
└── vehicles/              # Another category
    └── ...
```

### Compiled Assets (`build/assets/meshes/`)

The asset compiler generates this structure in the build directory:

```
build/assets/meshes/
├── index.json             # Central asset index
├── props/                 # Preserves category structure
│   ├── sun/               # Individual mesh directory
│   │   ├── geometry.cobj  # Compiled mesh file
│   │   ├── material.mtl   # Material definition
│   │   ├── texture.png    # Generated/copied texture
│   │   └── metadata.json  # Processed metadata
│   ├── wedge_ship/
│   │   ├── geometry.cobj
│   │   ├── material.mtl
│   │   ├── texture.png
│   │   └── metadata.json
│   └── control_tower/
│       ├── geometry.cobj
│       ├── material.mtl
│       ├── texture.png
│       └── metadata.json
│   ├── cube.json          # Per-mesh metadata
│   ├── cube.mtl           # Processed material file
│   └── cube.png           # Processed texture
├── props/
│   ├── control_tower.cobj
│   ├── control_tower.json
│   ├── control_tower.mtl
│   ├── control_tower.png
│   ├── wedge_ship.cobj
│   ├── wedge_ship.json
│   ├── wedge_ship.mtl
│   └── wedge_ship.png
└── vehicles/
    └── ...
```

## Naming Standards and Conventions

### File Naming

- **Source files**: Use `snake_case` for consistency: `wedge_ship.obj`, `control_tower.mesh`
- **Asset names**: The compiler automatically generates display names with proper capitalization: `Wedge_ship`, `Control_tower`
- **Case sensitivity**: The engine performs case-insensitive mesh lookups, so templates can reference `wedge_ship` or `Wedge_ship` interchangeably

### Directory Categories

Organize assets by logical categories:
- `platonic_solids/` - Basic geometric shapes
- `props/` - Environmental objects, structures
- `vehicles/` - Ships, aircraft, ground vehicles  
- `weapons/` - Projectiles, turrets, etc.
- `effects/` - Particle systems, visual effects

## Supported Source Formats

### Primary: `.mesh` files
Standard Wavefront OBJ format with `.mesh` extension:
```
mtllib mesh_name.mtl
usemtl MaterialName

v 0.0 0.0 1.0    # Vertices
vt 0.5 0.5       # Texture coordinates  
vn 0.0 1.0 0.0   # Normals

f 1/1/1 2/2/2 3/3/3  # Faces (vertex/texture/normal)
```

### Alternative: `.obj` files
Standard Wavefront OBJ format also supported.

## Material Definition (.mtl)

Materials must be defined in accompanying `.mtl` files:
```
newmtl MaterialName
Ka 0.2 0.2 0.3      # Ambient color
Kd 0.6 0.7 0.9      # Diffuse color  
Ks 0.8 0.8 0.8      # Specular color
Ns 32.0             # Shininess
map_Kd texture.png  # Diffuse texture map
```

## Compiled Metadata Schema

The asset compiler generates `.json` metadata files for each mesh:

```json
{
    "name": "Display_name",
    "tags": ["category", "autogenerated"],
    "description": "Descriptive text for the mesh",
    "filename": "mesh_name.cobj",
    "mtl": "mesh_name.mtl", 
    "texture": "mesh_name.png"
}
```

## Asset Compilation

### Build Integration

The asset compiler is integrated into the build system:

```bash
make with-assets    # Build game with asset compilation
make clean-assets   # Clean compiled assets only
make assets         # Compile assets only
```

### Manual Compilation

For development and testing:

```bash
python3 tools/asset_compiler.py \
    --source_dir assets/meshes \
    --build_dir build/assets/meshes
```

### Requirements

The asset compiler requires Python dependencies:
```bash
pip install trimesh cairosvg numpy scipy jsonschema
```

## Engine Integration

### Mesh Loading

The engine loads assets via the central index:
1. Reads `build/assets/meshes/index.json`
2. Loads each mesh's metadata file
3. Parses the compiled `.cobj` mesh data
4. Loads associated materials and textures
5. Registers assets with case-insensitive names

### Entity Template References

Entity templates can reference meshes by name (case-insensitive):

```
template: player_ship
mesh_name=wedge_ship_mk2    # Matches "Wedge_ship_mk2"

template: building  
mesh_name=control_tower     # Matches "Control_tower"
```

## Quality Standards

### Mesh Requirements
- **Triangulated faces only** - Quads will be triangulated automatically
- **Consistent winding order** - Counter-clockwise for outward-facing normals
- **UV coordinates** - Required for texturing (0.0-1.0 range)
- **Vertex limits** - Recommended maximum 2048 vertices per mesh
- **Manifold geometry** - Closed, watertight meshes preferred

### Texture Guidelines
- **Format**: PNG recommended, 32-bit RGBA supported
- **Resolution**: Power-of-2 dimensions (64x64, 128x128, 256x256, 512x512, 1024x1024)
- **Optimization**: Use appropriate resolution for in-game scale
- **Naming**: Must match material `map_Kd` reference

### Performance Considerations
- **LOD planning** - Consider multiple detail levels for complex models
- **Polygon budget** - Keep triangle count appropriate for usage
- **Texture memory** - Balance quality vs. memory usage
- **Batch compatibility** - Group related assets for efficient rendering

## Development Workflow

1. **Create source mesh** in preferred 3D software
2. **Export as .obj** or save as .mesh format
3. **Create accompanying .mtl** material file
4. **Generate or create texture** as .png file
5. **Place in appropriate category** directory
6. **Run asset compilation** via make system
7. **Test in engine** and iterate as needed

## Troubleshooting

### Common Issues
- **"Mesh may be corrupt"** - Check OBJ format syntax, ensure proper face definitions
- **"No source meshes found"** - Verify files have .obj or .mesh extensions
- **Case sensitivity** - Engine handles this automatically, but ensure consistent naming
- **Missing textures** - Check that .png files exist and are referenced correctly in .mtl

### Validation
- Use `make assets` to compile and validate mesh integrity  
- Check console output for detailed error messages
- Verify generated .cobj files are created successfully

## Asset Workflow

### Source to Build Pipeline

1. **Source assets** in `assets/meshes/` contain:
   - `geometry.mesh` - Source mesh file (or `geometry.obj`)
   - `material.mtl` - Material definition
   - `texture.png` - Texture file  
   - `metadata.json` - Asset metadata referencing source files

2. **Asset compiler** (`tools/asset_compiler.py`):
   - Reads source metadata from `assets/meshes/`
   - Preserves source filenames in compiled metadata
   - Generates `geometry.cobj` compiled mesh files
   - Copies materials and textures to build directory
   - Creates build index for the engine

3. **Mesh viewer** (`tools/mesh_viewer/`):
   - Reads build metadata to get asset list
   - Prefers source files for viewing when available
   - Shows compilation status (source vs compiled only)
   - Falls back to compiled assets if source missing

4. **Game engine**:
   - Loads only from build directory (`build/assets/meshes/`)
   - Uses compiled `.cobj` files for optimal performance
   - References assets via the build index

### Metadata Format

Source metadata files (`metadata.json`) should reference source files:

```json
{
    "name": "Wedge Ship",
    "filename": "geometry.mesh",  // Source file, not .cobj
    "tags": ["ship", "vehicle", "spacecraft"],
    "description": "A simple wedge-shaped spacecraft",
    "mtl": "material.mtl",
    "texture": "texture.png"
}
```

The asset compiler preserves this metadata in the build directory, allowing tools to understand the source->build relationship

### Automatic .obj Generation

For mesh viewer compatibility, the asset compiler automatically creates `geometry.obj` copies when processing `.mesh` files:

- **Source .mesh files**: Used by the game engine for loading (OBJ-compatible format)
- **Auto-generated .obj files**: Created in the same directory for Three.js mesh viewer compatibility
- **Compiled .cobj files**: Optimized versions in the build directory for game runtime

This ensures that:
- Developers can use either `.mesh` or `.obj` formats as preferred
- The mesh viewer can always display meshes using Three.js OBJLoader
- The game engine gets optimized compiled assets
- No manual conversion steps are required
